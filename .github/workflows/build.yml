name: iOS Archive

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  archive:
    name: Build and Archive iOS App
    runs-on: macos-latest

    steps:
      # 1. リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3
        
      # 2. XcodeGen をインストール
      - name: Install XcodeGen
        run: brew install xcodegen
      
      - name: Rename folder to remove space
        run: mv "Pocket Poster" PocketPoster
        
      - name: check where i am
        run: ls -a

      # 3. XcodeGen でプロジェクト生成
    　- name: Generate Xcode project
  　　　　working-directory: ./PocketPoster
  　　　run: xcodegen generate

      # 4. Swift Package 依存解決
      - name: Resolve Swift Packages
        run: xcodebuild -resolvePackageDependencies -project PocketPoster.xcodeproj

      # 5. アーカイブ生成（署名なし）
      - name: Archive app
        run: |
          xcodebuild archive \
            -project PocketPoster.xcodeproj \
            -scheme PocketPoster \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/PocketPoster.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            SKIP_INSTALL=NO

      # 6. アーカイブを GitHub Actions にアップロード（ダウンロード可能）
      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: PocketPosterArchive
          path: build/PocketPoster.xcarchive
